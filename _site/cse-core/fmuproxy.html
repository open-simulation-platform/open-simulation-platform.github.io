<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>fmuproxy - Core Simulation Environment</title>
<meta name="description" content="co-simulation software ">



<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Core Simulation Environment">
<meta property="og:title" content="fmuproxy">
<meta property="og:url" content="http://0.0.0.0:4000/cse-core/fmuproxy">


  <meta property="og:description" content="co-simulation software ">












<link rel="canonical" href="http://0.0.0.0:4000/cse-core/fmuproxy">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "http://0.0.0.0:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Core Simulation Environment Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--default">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Core Simulation Environment
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      <h2 id="fmuproxy">FMUProxy</h2>

<h3 id="1-proxy-server">1. Proxy-server</h3>

<p>A proxy-server is responsible for making available one or more FMUs over a set of RPCs. Implementations should support Thrift and or gRPC. Additional RPCs, such as JSON-RPC can also be supported.</p>

<p>In addition to the RPC support, a full implementation must be able to communicate with the discovery service over HTTP. Upon starting the server, the address of a discovery service should be specified. In order to ensure that the list of available FMUs is up to date, the server must ping the discovery service over HTTP, signaling that it is still online. When enough time has passed without such a notification, the server is considered offline and is removed from the discovery service.</p>

<p>The framework supports both ME and CS FMUs running on the back-end, but the user is only provided with a CS API, as ME models are wrapped. The user can configure which solver will be used for wrapping the ME model, subject to availability of certain solvers, which depends on the server implementation.</p>

<p>Two server implementations have been realized, each described
more in detail below. Which one to deploy in production
depends on the users need for RPCs supported,
stability, stability, quality of the available ME solvers,
memory foot-print and performance. No one implementation
will excel at everything.</p>

<h4 id="jvm">JVM</h4>

<p>The JVM implementation is written in Kotlin and rely on FMI4j, an FMI implementation for JVM languages that supports FMI 1.0 and 2.0 for CS and ME. Out of the box, ME models can be wrapped as CS ones using solvers from the Apache Commons Math3 package. Compared to other open-source FMI implementations targeting the JVM, such as JFMI and JavaFMI, FMI4j is the only one to support ME for 2.0. Furthermore, FMI4j uses the Java Native Interface (JNI) rather than Java Native Access (JNA) for interfacing with the native FMI functions, which significantly improves performance. The calling overhead for a single native call using JNA can be an order of magnitude greater than equivalent JNI.</p>

<p>The implementation supports Thrift (TCP/IP - binary, HTTP - JSON), gRPC (HTTP2 - protocol buffers) and is considered as the reference implementation.</p>

<h4 id="c">C++</h4>

<p>The C++ implementation is cross-platform and is written in modern C++17. All dependencies are available using the cross-platform package manager conan, making it easy to build. Currently, Thrift (TCP/IP - binary, HTTP - JSON) and gRPC (HTTP2 - protocol buffers) are supported RPCs.</p>

<p>FMI4cpp, an FMI 2.0 implementation for C++, is used for interacting with FMUs. It supports both CS and ME, where the latter can be wrapped as the former using solvers from Boost odeint. The main goal of the FMI4cpp library is to be as easy to use and install as possible. To achieve this, it makes use of modern C++ features and supports installation using the vcpkg and conan package managers.</p>

<h3 id="2-proxy-clients">2. Proxy-clients</h3>

<p>Proxy clients are used to connect with the FMUs hosted by the remote server(s). FMU-proxy aims to provide flexibility, such that clients can be implemented in a wide variety of languages and platform. 
Using Thrift or gRPC, the process of generating the required source-code for interacting with an remote FMU is quite straightforward. Listing. 1 shows the command required for generating the required sources when targeting Thrift in JavaScript. Similarly, Listing. 2 shows how C++ sources for gRPC are generated.</p>

<p><strong>Listing 1. Generating JavaScript sources for interfacing ith remote FMUs using Thrift.</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">thrift</span> <span class="o">-</span><span class="n">js</span> <span class="n">service</span><span class="o">.</span><span class="na">thift</span>
</code></pre></div></div>

<p><strong>Listing 2. Generating C++ sources for interfacing with remote FMUs using gRPC.</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">protoc</span> <span class="o">-</span><span class="no">I</span><span class="o">=.</span> <span class="o">--</span><span class="n">plugin</span><span class="o">=</span><span class="n">protoc</span><span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">grpc</span><span class="o">=</span> <span class="n">grpc_cpp_plugin</span> <span class="o">--</span><span class="n">cpp_out</span><span class="o">=.</span> <span class="o">--</span> <span class="n">grpc_out</span><span class="o">=.</span> <span class="n">service</span><span class="o">.</span><span class="na">proto</span>
</code></pre></div></div>

<p>FMU-proxy comes bundled with client implementations
for C++, the JVM, Python and JavaScript. The two latter
are crude and ought to be considered as proof of concept.
They are, however, bundled with the source code to
showcase how easy it is to interface with FMU-proxy from
new languages. A MATLAB demo using JSON-RPC over
HTTP is also available.</p>

<p>The C++ and JVM implementations are more elaborate,
providing a unified, higher level API for the users.
No matter which RPC is used, there is no difference between
a remote and local FMU slave for the user. As illustrated
by Figure. 3, they all share the same interface,
defined by FMI4cpp and FMI4j for C++ and JVM implementations
respectively. Assuming a tool is using one of
these FMI implementations, support for distributed execution
can be seamlessly added with minimal changes to the
existing code base. See Listing. 3 for an example.</p>

<figure>
<img src="/assets/img/fmuproxyFig3.png" /> 
<figcaption>Fig.3 FMI4cpp and FMI4jâ€™s slave interface could hide
                 slaves stemming from either an in-memory implementation or
                 an actual FMU. A slave in any language supported by the chosen
                 RPC could also be implemented directly behind the RPC
                 layer. </figcaption>
</figure>

<p><strong>Listing 3. JVM Thrift example, written in Kotlin.</strong></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">localModel</span><span class="p">:</span> <span class="nc">Model</span> <span class="p">=</span> <span class="nc">Fmu</span><span class="p">.</span><span class="nf">from</span> <span class="p">(&lt;</span><span class="n">url</span> <span class="n">or</span> <span class="n">file</span><span class="p">&gt;)</span> <span class="c1">//FMI4j API</span>
<span class="kd">val</span> <span class="py">remoteModel</span><span class="p">:</span> <span class="nc">Model</span> <span class="p">=</span> <span class="nc">ThriftFmuClient</span><span class="p">.</span>
    <span class="nf">socketClient</span><span class="p">(&lt;</span><span class="n">host</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="n">port</span><span class="p">&gt;).</span> <span class="nf">load</span><span class="p">(&lt;</span><span class="n">guid</span><span class="p">,</span> <span class="n">url</span> <span class="n">or</span> <span class="n">file</span><span class="p">&gt;)</span>
     
<span class="kd">val</span> <span class="py">model</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span> <span class="c1">// pne of the above</span>

<span class="kd">val</span> <span class="py">stepSize</span> <span class="p">=</span> <span class="p">---</span>
<span class="kd">val</span> <span class="py">slave</span> <span class="p">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">newInstance</span><span class="p">()</span>
<span class="n">slave</span><span class="p">.</span><span class="nf">simpleSetup</span><span class="p">()</span>
<span class="n">slave</span><span class="p">.</span><span class="nf">doStep</span><span class="p">(</span><span class="n">stepSize</span><span class="p">)</span>
<span class="n">slave</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
</code></pre></div></div>

<p>After running the JavaScript code generation using the command shown earlier in Listing. 1, the code shown in Listing. 4 can be written. Here, Thrift is configured to use HTTP transport and JSON encoding. Subsequently an FMU slave is instantiated on the remote server and stepped for 1s until termination. The process is similar for the 14+ other languages supported by Thrift, as well as gRPC and its many supported languages.</p>

<p><strong>Listing 4. Invoking an FMU from JavaScript using Thrift over HTTP.</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">transport</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thrift</span><span class="o">.</span><span class="na">TXHRTransport</span><span class="o">(</span><span class="s">"http://localhost:9091/thrift"</span><span class="o">)</span>
<span class="kt">var</span> <span class="n">protocol</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thrift</span><span class="o">.</span><span class="na">TJSONProtocol</span><span class="o">(</span><span class="n">transport</span><span class="o">)</span>
<span class="kt">var</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FmuServiceClient</span><span class="o">(</span><span class="n">protocol</span><span class="o">)</span>
<span class="kt">var</span> <span class="n">fmu_id</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">loadFromXXX</span><span class="o">()</span> <span class="c1">//load from url or guid</span>
<span class="kt">var</span> <span class="n">slave_id</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">creatInstanceFromCS</span><span class="o">(</span><span class="n">fmu_id</span><span class="o">)</span>

<span class="n">client</span><span class="o">.</span><span class="na">setupExperiment</span><span class="o">(</span><span class="n">slave_id</span><span class="o">)</span>
<span class="n">client</span><span class="o">.</span><span class="na">enterInitializationMode</span><span class="o">(</span><span class="n">slave_id</span><span class="o">)</span>
<span class="n">client</span><span class="o">.</span><span class="na">exitInitializationMode</span><span class="o">(</span><span class="n">slave_id</span><span class="o">)</span>

<span class="kt">var</span> <span class="n">stop</span> <span class="o">=</span><span class="mf">1.0</span>
<span class="kt">var</span> <span class="n">step_size</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mi">100</span>
<span class="k">do</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">step</span><span class="o">(</span><span class="n">slave_id</span><span class="o">,</span> <span class="n">step_size</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">status</span> <span class="o">!=</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">break</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">simulationTime</span> <span class="o">&lt;=</span><span class="n">stop</span><span class="o">)</span>
<span class="n">client</span><span class="o">.</span><span class="na">terminate</span><span class="o">(</span><span class="n">slave_id</span><span class="o">)</span>
</code></pre></div></div>

<h3 id="3-install-dependencies">3. Install dependencies</h3>
<h4 id="conan">Conan:</h4>
<p>Just add a new remote and re-run conan install with</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-o fmuproxy=True
</code></pre></div></div>

<p>conan remote add</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helmesjo "https://api.bintray.com/conan/helmesjo/public-conan"
</code></pre></div></div>

<h4 id="manual-building">Manual building:</h4>
<p>thrift can be built manually following these <a href="https://thrift.apache.org/lib/cpp">steps</a></p>

<p>Download a FMU-proxy server:
<a href="https://github.com/NTNU-IHB/FMU-proxy/releases/tag/v0.5.2">FMU-proxy</a></p>

<p>FMU-proxy server comes in two flavors: C++ and JVM.</p>

<p>Prefer to use the JVM version as it is cross-platform and has more features. Like support for FMI 1.0.</p>

<h3 id="4-run-the-fmu-proxy-server">4. Run the FMU-proxy server:</h3>

<p>To get started, start the server executable fmu-proxy.jar from a command line or use the bundled startup script, where -thrift/tcp 9090 tells fmu-proxy to start a Thrift RPC server listening to port 9090.
Start as many as necesssary servers on the same PC, but remember to use unique port numbers for each one. Please check that this port matches the
one(s) used in the configuration file.</p>

<h4 id="c-1">C++:</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./fmu_proxy_cpp -thrift/tcp 9090
</code></pre></div></div>

<p>You can pre-load FMUs using the -f switch.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FMU-proxy
Options:
  -h [ --help ]         Print this help message and quits.
  --fmu arg             Path to FMUs.
  --thrift/tcp arg      Specify the Thrift tcp port (enables this server).
  --thrift/http arg     Specify the Thrift http port  (enables this server).
  --grpc arg            Specify gRPC port (enables this server).
</code></pre></div></div>

<h4 id="jvm-1">JVM:</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start</span> <span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">fmu</span><span class="o">-</span><span class="n">proxy</span><span class="o">.</span><span class="na">jar</span> <span class="o">-</span><span class="n">thrift</span><span class="o">/</span><span class="n">tcp</span> <span class="mi">9090</span>
</code></pre></div></div>

<p>FMUs can be pre-loaded by appending the paths at the end of the command, no switch needed.</p>

<p>For each executable -h will display a help message with available options.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Usage: fmu-proxy [-h] 
                 [-grpc=&lt;grpcPort&gt;]
                 [-r=&lt;remote&gt;] [-thrift/http=&lt;thriftHttpPort&gt;]
                 [-thrift/tcp=&lt;thriftTcpPort&gt;] FMUs...
      FMUs...             FMU(s) to include.
      -grpc=&lt;grpcPort&gt;    Specify the gRPC port (enables this server).
  -h, --help              Print this message and quits.
      -thrift/http=&lt;thriftHttpPort&gt; Specify the Thrift http port (enables this server).
      -thrift/tcp=&lt;thriftTcpPort&gt; Specify the Thrift tcp port (enables this server).
</code></pre></div></div>

<h3 id="5-run-the-fmuproxy_test-located-in-the-test-folder">5. Run the fmuproxy_test located in the test folder</h3>
<p>This test takes 3 arguments:</p>

<ul>
  <li>url</li>
  <li>host</li>
  <li>port</li>
</ul>

<p>Download an <a href="http://folk.ntnu.no/laht/files/ControlledTemperature.fmu">Example</a> localhost 9090</p>

<p>Note: If you pre-loaded the server executable with some FMUs, you can use from_guid rather than from_url. (The guid is the guid found in the modelDescription.xml of the requested FMU)</p>

<p>See below for three different ways to specify the FMU to be loaded by fmu-proxy.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Simulators&gt;</span>
    <span class="nt">&lt;Simulator</span> <span class="na">name=</span><span class="s">"FMU1"</span>
        <span class="na">source=</span><span class="s">"fmu-proxy://localhost:9090?file=path/to/fmu1.fmu"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Simulator</span> <span class="na">name=</span><span class="s">"FMU2"</span>
        <span class="na">source=</span><span class="s">"fmu-proxy://localhost:9090?http://example.com/fmu2.fmu"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Simulator</span> <span class="na">name=</span><span class="s">"FMU3"</span>
        <span class="na">source=</span><span class="s">"fmu-proxy://localhost:9090?guid=&lt;fmu-guid-from-modelDescriptiongoes-
here&gt;"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/Simulators&gt;</span>
</code></pre></div></div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Core Simulation Environment. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
